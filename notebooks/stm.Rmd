---
title: "Navigo Topic Model"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load dataset

```{r}
library(dplyr)

reddit_waze_path <- file.path(getwd(), "../raw/raw_textonly_waze.json")
reddit_waze_raw <- read_json(reddit_waze_path, simplifyVector = TRUE)
```

## Tidy Text

```{r}
reddit_waze_tidy <- reddit_waze_raw %>% 
  replace_with_na_all(condition = ~.x %in% common_na_strings) %>% 
  replace_with_na_all(condition = ~.x == "[deleted]") %>% 
  drop_na(body)

library(tidytext)

reddit_waze_tidy <- reddit_waze_tidy %>% 
  unnest_tokens(word, body, token = "words") %>% 
  anti_join(get_stopwords()) %>% 
  filter(!str_detect(word, "[0-9]+")) %>% 
  add_count(word) %>% 
  filter(n > 100) %>% 
  select(-n) %>% 
  count(id, word) %>% 
  cast_sparse(id, word, n)
```

## Train STM

```{r}
library(stm)
library(furrr)

many_models <- data_frame(K = c(10, 30, 50, 70, 100)) %>%
  mutate(topic_model = future_map(K, ~stm(reddit_waze_tidy, K = ., verbose = FALSE)))
```

## Explore good K

```{r}
heldout <- make.heldout(reddit_waze_tidy)

k_result <- many_models %>%
  mutate(exclusivity = map(topic_model, exclusivity),
         semantic_coherence = map(topic_model, semanticCoherence, reddit_waze_tidy),
         eval_heldout = map(topic_model, eval.heldout, heldout$missing),
         residual = map(topic_model, checkResiduals, reddit_waze_tidy),
         bound =  map_dbl(topic_model, function(x) max(x$convergence$bound)),
         lfact = map_dbl(topic_model, function(x) lfactorial(x$settings$dim$K)),
         lbound = bound + lfact,
         iterations = map_dbl(topic_model, function(x) length(x$convergence$bound)))

k_result
```

## Plot Model diagnostics

```{r}
k_result %>%
  transmute(K,
            `Lower bound` = lbound,
            Residuals = map_dbl(residual, "dispersion"),
            `Semantic coherence` = map_dbl(semantic_coherence, mean),
            `Held-out likelihood` = map_dbl(eval_heldout, "expected.heldout")) %>%
  gather(Metric, Value, -K) %>%
  ggplot(aes(K, Value, color = Metric)) +
  geom_line(size = 1.5, alpha = 0.7, show.legend = FALSE) +
  facet_wrap(~Metric, scales = "free_y") +
  labs(x = "K (number of topics)",
       y = NULL,
       title = "Model diagnostics by number of topics",
       subtitle = "These diagnostics indicate that a good number of 
       topics would be around 48") +
  theme_tufte()
```
